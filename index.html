<script>
const CHANNEL_ID = 3224423;
const BASE_URL = "https://api.thingspeak.com/channels/" + CHANNEL_ID;

async function loadLatest() {
  const res = await fetch(BASE_URL + "/feeds/last.json");
  const data = await res.json();

  document.getElementById("power").textContent =
    Number(data.field4).toFixed(0);

  document.getElementById("energy").textContent =
    Number(data.field2).toFixed(3);
}

async function loadToday() {
  const res = await fetch(BASE_URL + "/feeds.json?results=500");
  const data = await res.json();

  const todayStart = new Date();
  todayStart.setHours(0, 0, 0, 0);

  renderHistory(data.feeds, todayStart);
}

async function loadMonth() {
  const res = await fetch(BASE_URL + "/feeds.json?results=2000");
  const data = await res.json();

  const monthStart = new Date();
  monthStart.setDate(1);
  monthStart.setHours(0, 0, 0, 0);

  renderHistory(data.feeds, monthStart);
}

function renderHistory(feeds, startTime) {
  const tbody = document.getElementById("history");
  tbody.innerHTML = "";

  feeds.forEach(f => {
    const time = new Date(f.created_at);

    if (time >= startTime) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${time.toLocaleString()}</td>
        <td>${Number(f.field4).toFixed(0)}</td>
        <td>${Number(f.field2).toFixed(3)}</td>
      `;
      tbody.appendChild(tr);
    }
  });
}

// auto refresh
loadLatest();
setInterval(loadLatest, 30000);
</script>
